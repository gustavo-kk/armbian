name: Compile Armbian Image

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl unzip make gcc

      - name: Clone Armbian Build Repository
        run: |
          git clone https://github.com/armbian/build.git
          cd build

          # Definindo variáveis de ambiente
          export BOARD="rk322x-box"
          export RELEASE="focal"          # Ubuntu 20.04
          export KERNEL_TARGET="legacy"    # Especifica o alvo do kernel
          export KERNEL_VERSION="4.4.194"  # Versão do kernel
          export BUILD_TYPE="server"       # Tipo de construção para servidor

          # Executar a compilação não interativa
          ./compile.sh EXPERT="yes" \
            CLEAN_LEVEL="none" \
            KERNEL_ONLY="no" \
            KERNEL_CONFIGURE="no" \
            BOARD="${BOARD}" \
            RELEASE="${RELEASE}" \
            KERNEL_TARGET="${KERNEL_TARGET}" \
            KERNEL_VERSION="${KERNEL_VERSION}" \
            BUILD_TYPE="${BUILD_TYPE}" \
            BOOTCONFIG="rk322x-box_defconfig" \
            BOOT_FDT_FILE="rk322x-box.dtb" \
            MODULES_LEGACY="hci_uart rfcomm hidp" \
            MODULES_BLACKLIST_LEGACY="ssv6051 8723cs r8188eu ssv6x5x"

      - name: Upload compiled image
        uses: actions/upload-artifact@v3
        with:
          name: armbian-image
          path: ./output/images/
